# Validate GitHub Secrets Configuration
#
# This workflow validates that all required secrets are configured for CI/CD pipeline.
# It runs on workflow_dispatch to allow manual verification of secrets setup.
#
# Required Secrets for Full Pipeline:
#   Docker Hub:
#     - DOCKERHUB_USERNAME: Docker Hub username
#     - DOCKERHUB_TOKEN: Docker Hub access token
#   VPS Deployment:
#     - VPS_HOST: VPS hostname or IP address
#     - VPS_USER: SSH username for VPS
#     - VPS_SSH_KEY: SSH private key for VPS access
#   Vercel (Frontend):
#     - VERCEL_TOKEN: Vercel authentication token
#     - VERCEL_ORG_ID: Vercel organization/team ID
#     - VERCEL_PROJECT_ID: Vercel project ID

name: Validate Secrets

on:
  workflow_dispatch:
    inputs:
      validate_docker:
        description: 'Validate Docker Hub secrets'
        type: boolean
        default: true
      validate_vps:
        description: 'Validate VPS SSH secrets'
        type: boolean
        default: true
      validate_vercel:
        description: 'Validate Vercel secrets'
        type: boolean
        default: true

jobs:
  validate-docker-secrets:
    name: Validate Docker Hub Secrets
    runs-on: ubuntu-latest
    if: ${{ inputs.validate_docker }}
    steps:
      - name: Check DOCKERHUB_USERNAME
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "âŒ DOCKERHUB_USERNAME is not configured"
            exit 1
          else
            echo "âœ… DOCKERHUB_USERNAME is configured"
          fi

      - name: Check DOCKERHUB_TOKEN
        run: |
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "âŒ DOCKERHUB_TOKEN is not configured"
            exit 1
          else
            echo "âœ… DOCKERHUB_TOKEN is configured"
          fi

      - name: Validate Docker Hub login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          if [ $? -eq 0 ]; then
            echo "âœ… Docker Hub authentication successful"
            docker logout
          else
            echo "âŒ Docker Hub authentication failed"
            exit 1
          fi

  validate-vps-secrets:
    name: Validate VPS SSH Secrets
    runs-on: ubuntu-latest
    if: ${{ inputs.validate_vps }}
    steps:
      - name: Check VPS_HOST
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "âŒ VPS_HOST is not configured"
            exit 1
          else
            echo "âœ… VPS_HOST is configured"
          fi

      - name: Check VPS_USER
        run: |
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "âŒ VPS_USER is not configured"
            exit 1
          else
            echo "âœ… VPS_USER is configured"
          fi

      - name: Check VPS_SSH_KEY
        run: |
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ VPS_SSH_KEY is not configured"
            exit 1
          else
            echo "âœ… VPS_SSH_KEY is configured"
          fi

      - name: Validate SSH key format
        run: |
          echo "${{ secrets.VPS_SSH_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          if ssh-keygen -l -f /tmp/ssh_key > /dev/null 2>&1; then
            echo "âœ… SSH key has valid format"
          else
            echo "âŒ SSH key format is invalid"
            rm -f /tmp/ssh_key
            exit 1
          fi
          rm -f /tmp/ssh_key

      - name: Test SSH connection (non-blocking)
        continue-on-error: true
        timeout-minutes: 1
        run: |
          echo "${{ secrets.VPS_SSH_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/ssh_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "echo 'SSH connection successful'" 2>/dev/null; then
            echo "âœ… SSH connection to VPS successful"
          else
            echo "âš ï¸ SSH connection test failed (this may be expected if VPS is not accessible from GitHub Actions)"
          fi
          rm -f /tmp/ssh_key

  validate-vercel-secrets:
    name: Validate Vercel Secrets
    runs-on: ubuntu-latest
    if: ${{ inputs.validate_vercel }}
    steps:
      - name: Check VERCEL_TOKEN
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âŒ VERCEL_TOKEN is not configured"
            exit 1
          else
            echo "âœ… VERCEL_TOKEN is configured"
          fi

      - name: Check VERCEL_ORG_ID
        run: |
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "âŒ VERCEL_ORG_ID is not configured"
            exit 1
          else
            echo "âœ… VERCEL_ORG_ID is configured"
          fi

      - name: Check VERCEL_PROJECT_ID
        run: |
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "âŒ VERCEL_PROJECT_ID is not configured"
            exit 1
          else
            echo "âœ… VERCEL_PROJECT_ID is configured"
          fi

      - name: Validate Vercel token
        run: |
          npm install -g vercel@latest
          if vercel whoami --token=${{ secrets.VERCEL_TOKEN }} > /dev/null 2>&1; then
            echo "âœ… Vercel token is valid"
          else
            echo "âŒ Vercel token validation failed"
            exit 1
          fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-docker-secrets, validate-vps-secrets, validate-vercel-secrets]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ” Secrets Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Docker Hub Secrets" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.validate-docker-secrets.result }}" == "success" ]; then
            echo "âœ… All Docker Hub secrets are configured and valid" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-docker-secrets.result }}" == "skipped" ]; then
            echo "â­ï¸ Validation skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Docker Hub secrets validation failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### VPS SSH Secrets" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.validate-vps-secrets.result }}" == "success" ]; then
            echo "âœ… All VPS secrets are configured" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-vps-secrets.result }}" == "skipped" ]; then
            echo "â­ï¸ Validation skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ VPS secrets validation failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Vercel Secrets" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.validate-vercel-secrets.result }}" == "success" ]; then
            echo "âœ… All Vercel secrets are configured and valid" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-vercel-secrets.result }}" == "skipped" ]; then
            echo "â­ï¸ Validation skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Vercel secrets validation failed" >> $GITHUB_STEP_SUMMARY
          fi
